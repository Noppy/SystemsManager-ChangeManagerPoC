AWSTemplateFormatVersion: 2010-09-09
#---------------------------------------
Parameters:
  #------------------
  InstanceType:
    Type: String
    Default: t2.micro
  AmiId:
    Type: AWS::EC2::Image::Id
  AutoRecoveryMinutes:
    Type: Number
    Default: 1
Metadata: 
  AWS::CloudFormation::Interface: 
    ParameterGroups: 
      -
        Label:
          default:  Instances
        Parameters:
          - InstanceType
          - AmiId
          - AutoRecoveryMinutes

#---------------------------------------
Resources:
  #--------IAM ROLE
  AdminRole:
    Type: AWS::IAM::Role
    Properties: 
      RoleName: "SsmAdminRole"
      Path: "/"
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              AWS:
                - !Sub "arn:aws:iam::${AWS::AccountId}:root"
            Action:
              - sts:AssumeRole
      Policies:
        - PolicyName: "SsmAdminSsmPolicy"
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              -
                Effect: "Allow"
                Action:
                  - "ssm:*"
                Resource: "*"
        - PolicyName: "SsmAdminIamPassRolePolicy"
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              -
                Effect: "Allow"
                Action:
                  - "iam:PassRole"
                Resource: "*"
  #--
  Ec2Role:
    Type: AWS::IAM::Role
    Properties: 
      RoleName: "Ec2-SsmTestRole"
      Path: "/"
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service:
                - ec2.amazonaws.com
            Action:
              - sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/AmazonSSMManagedInstanceCore
  Ec2RoleProfile:
    Type: AWS::IAM::InstanceProfile
    Properties:
      Path: "/"
      Roles:
        - !Ref Ec2Role
  #--

  #--------Security Group for WebServer
  SG:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupName: SsmTest-TestInstanceSg
      GroupDescription: SG for Ssm Test Test
      VpcId: 
        Fn::ImportValue: SsmTest-VPC-VpcId
      Tags:
        - Key: Name
          Value: SsmTest-TestInstanceSg
  #------------------ WebServer:
  Instance:
    Type: AWS::EC2::Instance
    Properties:
      ImageId: !Ref AmiId
      InstanceType: !Ref InstanceType
      IamInstanceProfile: !Ref Ec2RoleProfile
      Monitoring: yes
      NetworkInterfaces:
        - DeviceIndex: '0'
          SubnetId:
            Fn::ImportValue: SsmTest-VPC-Subnet1Id
          GroupSet:
            - !Ref SG
          AssociatePublicIpAddress: true
      Tags:
        - Key: Name
          Value: SsmTest-TestInstance
      UserData:
        Fn::Base64: 
          Fn::Join:
            - ""
            - - !Sub |
                #!/bin/bash -xe
                # Update ALL rpms, and change hostname to Userfrendly name 
                yum -y update
                hostnamectl set-hostname "SsmTest-TestInstance"
  InstanceRecovery:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmDescription: AutoRecovery for the Proxy
      Namespace: AWS/EC2
      MetricName: StatusCheckFailed_System
      Statistic: Minimum
      Period: 60
      EvaluationPeriods: !Ref AutoRecoveryMinutes
      ComparisonOperator: GreaterThanThreshold
      Threshold: 0
      AlarmActions:
      - !Sub "arn:aws:automate:${AWS::Region}:ec2:recover"
      - !Sub "arn:aws:sns:${AWS::Region}:${AWS::AccountId}:admin"
      Dimensions:
      - Name: InstanceId
        Value: !Ref Instance
#---------------------------------------
Outputs:
  Ec2RoleArn:
    Value: !GetAtt Ec2Role.Arn
    Export:
      Name: !Sub ${AWS::StackName}-Ec2RoleArn
  Ec2RoleId:
    Value: !Ref Ec2Role
    Export:
      Name: !Sub ${AWS::StackName}-Ec2RoleId
  #--
  AdminRoleArn:
    Value: !GetAtt AdminRole.Arn
    Export:
      Name: !Sub ${AWS::StackName}-AdminRoleArn
  AdminRoleId:
    Value: !Ref AdminRole
    Export:
      Name: !Sub ${AWS::StackName}-AdminRoleId
  #---------------- EC2 Instance
  InstanceId:
    Description: Instance ID
    Value: !Ref Instance
    Export:
      Name: !Sub ${AWS::StackName}-InstanceId
  InstancePrivateIp:
    Description: Instance PrivateIP
    Value: !GetAtt Instance.PrivateIp
    Export:
      Name: !Sub ${AWS::StackName}-InstancePrivateIp